# Автоматизированное решение задачи детектирования, сегментации, классификации объектов на ортофотоплане с помощью нейронной сети YOLO в программе Agisoft Metashape

## Введение

Проект посвящён разработке решения для автоматизированного детектирования, сегментации и классификации животных на ортофотопланах, полученных в результате аэрофотосъёмки лежбищ северных морских львов и северных морских котиков. Задача детектирования объектов является универсальной для различных типов изображений; различия проявляются в точности распознавания и технических средствах, используемых на разных этапах обработки данных.

В рамках проекта используются аэрофотоматериалы, полученные в ходе съёмок с беспилотных летательных аппаратов. Обработка снимков, включающая совмещение перекрывающихся изображений для построения ортофотопланов, представляет собой трудоёмкий и ресурсоёмкий процесс, автоматизация которого на данный момент реализована лишь частично.

В качестве одного из ключевых компонентов разработан встроенный модуль для программного продукта Agisoft Metashape, реализующий функции автоматического поиска, сегментации и классификации животных. Для решения задачи применена архитектура сверточной нейронной сети YOLO (You Only Look Once), обеспечивающая высокую производительность и приемлемую точность при ограниченных вычислительных ресурсах.## Принцип работы основных функций модуля

### 1. Функция detect_objects()

Функция `detect_objects()` является основным интерфейсом для запуска процесса детектирования объектов на ортофотоплане. Принцип работы функции:

1. **Проверка входных данных**:
   - Проверяется наличие активного ортофотоплана в текущем проекте Metashape.
   - Проверяется разрешение ортофотоплана (должно быть не более 10 см/пиксель).

2. **Создание пользовательского интерфейса**:
   - Создается экземпляр класса `MainWindowDetect`, который предоставляет графический интерфейс для настройки параметров детектирования.

3. **Процесс детектирования** (метод `detect()` класса `MainWindowDetect`):
   - **Разделение ортофотоплана на тайлы**: Ортофотоплан разделяется на большие тайлы, которые затем разделяются на меньшие подтайлы для обработки. Это позволяет обрабатывать ортофотопланы большого размера, не загружая их целиком в память.
   - **Обработка каждого подтайла с помощью YOLO**: Каждый подтайл обрабатывается моделью YOLO, которая возвращает обнаруженные объекты с их ограничивающими рамками (bounding boxes) и, если доступно, масками сегментации.
   - **Обработка перекрывающихся областей**: Применяется алгоритм подавления немаксимумов (NMS) для устранения дублирующихся обнаружений в перекрывающихся областях соседних тайлов.
   - **Преобразование координат**: Координаты обнаруженных объектов преобразуются из пиксельных координат тайла в мировые координаты ортофотоплана.
   - **Создание векторных объектов**: Для каждого обнаруженного объекта создается векторный объект (полигон) в Metashape с соответствующими атрибутами (класс, уверенность).

4. **Визуализация результатов**:
   - Обнаруженные объекты отображаются в виде векторных слоев в Metashape.
   - Создаются два слоя: один для ограничивающих рамок (bounding boxes) и один для контуров сегментации.

### 2. Функция convert_shapes()

Функция `convert_shapes()` предназначена для преобразования между различными представлениями векторных объектов. Принцип работы функции:

1. **Проверка входных данных**:
   - Проверяется наличие активного ортофотоплана в текущем проекте Metashape.
   - Проверяется разрешение ортофотоплана (должно быть не более 10 см/пиксель).

2. **Создание пользовательского интерфейса**:
   - Создается экземпляр класса `WindowConvertShapes`, который предоставляет графический интерфейс для настройки параметров преобразования.

3. **Процесс преобразования** (метод `run_convert_shapes()` класса `WindowConvertShapes`):
   - В зависимости от выбранного режима, вызывается либо `create_boxes_from_points()`, либо `create_points_from_boxes()`.

4. **Преобразование точек в ограничивающие рамки** (метод `create_boxes_from_points()`):
   - Для каждой точки из исходного слоя:
     - Извлекается метка (класс) точки.
     - Координаты точки преобразуются в систему координат ортофотоплана.
     - Если указаны зоны, проверяется, находится ли точка внутри какой-либо зоны.
   - Создаются ограничивающие рамки вокруг точек с заданным размером.
   - Ограничивающие рамки добавляются как полигональные объекты в новый слой Metashape.

5. **Преобразование ограничивающих рамок в точки** (метод `create_points_from_boxes()`):
   - Для каждой ограничивающей рамки из исходного слоя:
     - Извлекается метка (класс) рамки.
     - Вычисляется центр рамки.
     - Если указаны зоны, проверяется, находится ли центр внутри какой-либо зоны.
   - Центры рамок добавляются как точечные объекты в новый слой Metashape.

### 3. Функция create_yolo_dataset()

Функция `create_yolo_dataset()` предназначена для создания набора данных для обучения моделей YOLO на основе ортофотоплана и векторных объектов. Принцип работы функции:

1. **Проверка входных данных**:
   - Проверяется наличие активного ортофотоплана в текущем проекте Metashape.
   - Проверяется разрешение ортофотоплана (должно быть не более 10 см/пиксель).

2. **Создание пользовательского интерфейса**:
   - Создается экземпляр класса `WindowCreateYoloDataset`, который предоставляет графический интерфейс для настройки параметров создания набора данных.

3. **Процесс создания набора данных** (метод `create_on_user_data()` класса `WindowCreateYoloDataset`):
   - **Обработка зон обучения**:
     - Для каждой зоны обучения находится оптимальное преобразование между мировыми координатами и пиксельными координатами.
     - Вычисляется ограничивающая рамка каждой зоны в пиксельных координатах.
     - Проверяется, достаточно ли велика зона для обучения.

   - **Обработка аннотаций**:
     - Для каждой аннотации в пределах зон обучения:
       - Преобразуются координаты вершин аннотации в координаты ортофотоплана.
       - Проверяется, перекрывается ли аннотация достаточно с зоной.
       - Назначается идентификатор класса для каждой уникальной метки.

   - **Разделение зон на тайлы**:
     - Каждая зона разделяется на тайлы фиксированного размера.
     - Для каждого тайла:
       - Извлекаются данные изображения из ортофотоплана.
       - Пропускаются тайлы, которые находятся за пределами ортофотоплана.
       - Находятся аннотации, которые перекрываются с тайлом.

   - **Применение аугментации данных** (если включено):
     - Для каждого тайла применяются различные преобразования (повороты, отражения).
     - Для каждого преобразованного тайла пересчитываются координаты аннотаций.

   - **Сохранение данных в формате YOLO**:
     - Изображения сохраняются в формате JPEG.
     - Аннотации сохраняются в формате YOLO (нормализованные координаты).
     - Создается структура каталогов, необходимая для YOLO.
     - Создается файл data.yaml с информацией о классах.

   - **Разделение на обучающую и валидационную выборки**:
     - Набор данных случайным образом разделяется на обучающую и валидационную выборки в соответствии с заданным соотношением.

   - **Визуализация аннотаций** (в режиме отладки):
     - Создаются визуализации аннотаций для проверки правильности преобразования.

## Технические особенности реализации

### Обработка больших ортофотопланов

Ортофотопланы, создаваемые по материалам аэрофотосъемки, могут быть очень большими (десятки тысяч пикселей в каждом измерении). Для эффективной обработки таких изображений модуль использует следующие подходы:

1. **Разделение на тайлы**: Ортофотоплан разделяется на тайлы фиксированного размера, которые обрабатываются по отдельности.
2. **Перекрытие тайлов**: Тайлы имеют перекрытие, чтобы объекты, находящиеся на границах тайлов, были полностью видны хотя бы в одном тайле.
3. **Обработка перекрывающихся обнаружений**: Применяется алгоритм подавления немаксимумов для устранения дублирующихся обнаружений в перекрывающихся областях.

### Преобразование координат

Модуль выполняет несколько преобразований координат:

1. **Из мировых координат в пиксельные**: Для извлечения тайлов из ортофотоплана.
2. **Из пиксельных координат тайла в пиксельные координаты ортофотоплана**: Для объединения результатов обнаружения из разных тайлов.
3. **Из пиксельных координат ортофотоплана в мировые координаты**: Для создания векторных объектов в Metashape.

### Аугментация данных

Для улучшения обучения модели YOLO модуль поддерживает различные методы аугментации данных:

1. **Геометрические преобразования**:
   - Повороты (на 90, 180, 270 градусов)
   - Зеркальные отражения
   - Комбинации поворотов и отражений

2. **Цветовые преобразования**:
   - Изменение яркости
   - Изменение контраста
   - Изменение насыщенности

### Формат данных YOLO

Модуль создает набор данных в формате, требуемом для обучения моделей YOLO:

1. **Структура каталогов**:
   ```
   dataset_yolo/
   ├── data.yaml
   ├── train/
   │   ├── images/
   │   └── labels/
   └── val/
       ├── images/
       └── labels/
   ```

2. **Формат аннотаций**:
   - Для обнаружения объектов:
     ```
     <class_id> <x_center_norm> <y_center_norm> <width_norm> <height_norm>
     ```
   - Для сегментации:
     ```
     <class_id> <x1> <y1> <x2> <y2> ... <xn> <yn>
     ```
   где `class_id` - идентификатор класса, а координаты нормализованы по размерам изображения.

3. **Файл data.yaml**:
   ```yaml
   train: train/images
   val: val/images
   nc: <number_of_classes>
   names: [<class_name_1>, <class_name_2>, ...]
   ```

## Заключение

Разработанный модуль для Agisoft Metashape предоставляет комплексное решение для автоматизации процесса детектирования, сегментации и классификации объектов на ортофотопланах с использованием нейронной сети YOLO. Модуль интегрируется в рабочий процесс Metashape, позволяя пользователям выполнять все этапы обработки в одной программе, без необходимости использования сторонних инструментов.

Основные преимущества модуля:
- Автоматизация трудоемкого процесса ручной разметки объектов на ортофотопланах
- Высокая производительность благодаря эффективной обработке больших изображений
- Поддержка как обнаружения объектов (bounding boxes), так и сегментации (контуры)
- Возможность создания наборов данных для обучения собственных моделей YOLO
- Интеграция с Metashape, обеспечивающая удобный рабочий процесс

Модуль может быть использован для различных задач, связанных с обработкой ортофотопланов, включая мониторинг численности животных, картографирование, сельское хозяйство, лесное хозяйство и другие области, где требуется автоматическое обнаружение и классификация объектов на аэрофотоснимках.